<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
  <meta name="theme-color" content="#1a56db">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>Inventur Scanner</title>
  <link rel="manifest" href="manifest.json">

  <!-- ZXing: Code128 + QR on iOS & Android -->
  <script src="https://unpkg.com/@zxing/library@0.18.6/umd/index.min.js"></script>
  <!-- SheetJS: read + write xlsx in browser -->
  <script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>
  <!-- QRCode.js: generate QR codes (qrcodejs via cdnjs) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --blue:   #1a56db;
      --green:  #38a169;
      --red:    #e53e3e;
      --orange: #dd6b20;
      --bg:     #f0f4f8;
      --card:   #ffffff;
      --border: #e2e8f0;
      --muted:  #718096;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: #1a202c;
      min-height: 100dvh;
      overflow-x: hidden;
    }

    /* â”€â”€ HEADER â”€â”€ */
    header {
      background: var(--blue);
      color: #fff;
      padding: 14px 16px 12px;
      text-align: center;
      position: sticky;
      top: 0;
      z-index: 60;
    }
    header h1 { font-size: 17px; font-weight: 700; }
    header p  { font-size: 12px; opacity: .75; margin-top: 2px; }

    /* â”€â”€ NAV â”€â”€ */
    nav {
      position: fixed;
      bottom: 0; left: 0; right: 0;
      background: var(--card);
      border-top: 1px solid var(--border);
      display: flex;
      z-index: 60;
      padding-bottom: env(safe-area-inset-bottom, 0px);
    }
    nav button {
      flex: 1; padding: 10px 4px 8px;
      background: none; border: none;
      font-size: 11px; color: var(--muted);
      display: flex; flex-direction: column; align-items: center; gap: 3px;
      cursor: pointer; -webkit-tap-highlight-color: transparent;
    }
    nav button .ico { font-size: 22px; line-height: 1; }
    nav button.active { color: var(--blue); }

    /* â”€â”€ PAGES â”€â”€ */
    .page { display: none; padding: 14px 14px 90px; }
    .page.active { display: block; }

    /* â”€â”€ CARD â”€â”€ */
    .card {
      background: var(--card);
      border-radius: 14px;
      padding: 16px;
      margin-bottom: 14px;
      box-shadow: 0 1px 4px rgba(0,0,0,.08);
    }
    .card h2 { font-size: 16px; font-weight: 700; margin-bottom: 10px; }

    /* â”€â”€ BUTTONS â”€â”€ */
    .btn {
      display: block; width: 100%;
      padding: 14px 16px;
      border-radius: 12px; border: none;
      font-size: 16px; font-weight: 600;
      cursor: pointer; text-align: center;
      -webkit-tap-highlight-color: transparent;
    }
    .btn + .btn { margin-top: 10px; }
    .btn-primary { background: var(--blue);   color: #fff; }
    .btn-success { background: var(--green);  color: #fff; }
    .btn-danger  { background: var(--red);    color: #fff; }
    .btn-outline { background: #fff; color: var(--blue); border: 2px solid var(--blue); }
    .btn-sm      { padding: 10px 14px; font-size: 14px; }

    /* â”€â”€ STATS â”€â”€ */
    .stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      margin-bottom: 14px;
    }
    .stat {
      background: var(--card);
      border-radius: 12px;
      padding: 12px 8px;
      text-align: center;
      box-shadow: 0 1px 3px rgba(0,0,0,.07);
    }
    .stat .n  { font-size: 30px; font-weight: 800; line-height: 1; }
    .stat .lbl{ font-size: 11px; color: var(--muted); margin-top: 3px; }
    .stat.ok   .n { color: var(--green); }
    .stat.miss .n { color: var(--red);   }
    .stat.xtra .n { color: var(--orange);}

    /* â”€â”€ PROGRESS â”€â”€ */
    .pbar { height: 8px; background: var(--border); border-radius: 4px; overflow: hidden; }
    .pfill{ height: 100%; background: var(--green); border-radius: 4px; transition: width .4s; }
    .ptext{ text-align: center; font-size: 12px; color: var(--muted); margin-top: 5px; }

    /* â”€â”€ SCANNER â”€â”€ */
    .scanner-wrap {
      position: relative;
      border-radius: 12px;
      overflow: hidden;
      background: #000;
    }
    .scanner-wrap video { width: 100%; display: block; }
    #scan-hint {
      text-align: center;
      color: var(--muted);
      font-size: 13px;
      padding: 10px 0 4px;
    }

    /* â”€â”€ MODAL â”€â”€ */
    .modal-bg {
      display: none;
      position: fixed; inset: 0;
      background: rgba(0,0,0,.55);
      z-index: 200;
      align-items: flex-end;
    }
    .modal-bg.open { display: flex; }
    .modal {
      background: var(--card);
      border-radius: 22px 22px 0 0;
      padding: 24px 20px;
      width: 100%;
      padding-bottom: calc(24px + env(safe-area-inset-bottom, 0px));
    }
    .modal-title   { font-size: 20px; font-weight: 800; margin-bottom: 2px; }
    .modal-sub     { font-size: 13px; color: var(--muted); margin-bottom: 18px; }

    /* info grid in modal */
    .info-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 8px;
      background: var(--bg);
      border-radius: 12px;
      padding: 12px;
      margin-bottom: 18px;
    }
    .info-grid.expert { grid-template-columns: repeat(3, 1fr); }
    .info-expert { display: none; }
    .info-grid.expert .info-expert { display: block; }
    .info-cell { text-align: center; }
    .info-cell .lbl { font-size: 11px; color: var(--muted); margin-bottom: 4px; }
    .info-cell .val { font-size: 24px; font-weight: 800; }
    .val-ok     { color: var(--green); }
    .val-warn   { color: var(--orange); }
    .val-neutral{ color: #2d3748; }

    /* qty control */
    .qty-row {
      display: flex; align-items: center;
      gap: 14px; margin: 4px 0 8px;
    }
    .qty-btn {
      width: 58px; height: 58px;
      border-radius: 50%; border: none;
      font-size: 30px; font-weight: 300;
      cursor: pointer; flex-shrink: 0;
      display: flex; align-items: center; justify-content: center;
    }
    .qty-btn.minus { background: #fed7d7; color: var(--red);   }
    .qty-btn.plus  { background: #c6f6d5; color: var(--green); }
    .qty-input-wrap { flex: 1; text-align: center; }
    #qty-val {
      width: 90px; height: 58px;
      border: 2px solid var(--border); border-radius: 12px;
      text-align: center; font-size: 30px; font-weight: 700;
      color: var(--blue);
    }
    .qty-total {
      text-align: center; font-size: 13px;
      color: var(--muted); margin: 6px 0 18px;
    }
    .qty-total strong { font-size: 20px; color: #1a202c; }

    /* â”€â”€ SEARCH â”€â”€ */
    .search-row { display: flex; gap: 8px; margin-bottom: 12px; }
    .search-row input {
      flex: 1; padding: 12px 14px;
      border: 2px solid var(--border); border-radius: 12px;
      font-size: 16px;
    }
    .search-row input:focus { outline: none; border-color: var(--blue); }
    .search-row button {
      padding: 12px 16px;
      background: var(--blue); color: #fff;
      border: none; border-radius: 12px;
      font-size: 20px; cursor: pointer;
    }

    /* result table */
    .rtable { width: 100%; border-collapse: collapse; font-size: 13px; }
    .rtable th {
      text-align: left; padding: 8px 6px;
      border-bottom: 2px solid var(--border);
      color: var(--muted); font-weight: 600;
    }
    .rtable td { padding: 9px 6px; border-bottom: 1px solid var(--bg); }
    .rtable tr:last-child td { border-bottom: none; }

    /* â”€â”€ QR export container â”€â”€ */
    #qr-container img, #qr-container canvas { border-radius: 8px; max-width: 100%; }

    /* â”€â”€ video QR modal â”€â”€ */
    #video-qr { width: 100%; border-radius: 12px; display: block; }

    /* â”€â”€ misc â”€â”€ */
    .hidden { display: none !important; }
    .divider { border: none; border-top: 1px solid var(--border); margin: 18px 0; }
    .tag {
      display: inline-block; padding: 3px 10px;
      border-radius: 999px; font-size: 12px; font-weight: 600;
    }
    .tag-ok   { background: #c6f6d5; color: #276749; }
    .tag-miss { background: #fed7d7; color: #742a2a; }
    .tag-xtra { background: #fefcbf; color: #744210; }

    details summary { cursor: pointer; user-select: none; padding: 6px 0; }
    details[open] summary { margin-bottom: 8px; }

    .btn-sound        { background: var(--green); color: #fff; border: none; }
    .btn-sound.off    { background: #fff; color: var(--muted); border: 2px solid var(--border); }

    /* â”€â”€ NORMAL / EXPERT MODE LAYOUT â”€â”€ */
    body:not(.expert-mode) .stats { display: none !important; }
    body:not(.expert-mode) nav { display: none; }
    body:not(.expert-mode) .page { padding-bottom: 30px; }
    #normal-finish-section { display: none; }
    body:not(.expert-mode) #normal-finish-section { display: block; }

  </style>
</head>

<body>

<header>
  <h1>ğŸ“¦ Inventur Scanner <span id="build-lbl" style="font-size:11px;font-weight:400;opacity:.55;cursor:default" onclick="onBuildTap()">Build 29</span></h1>
  <p id="hdr-sub">Keine Inventurdatei geladen</p>
</header>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• PAGE: INVENTUR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="page active" id="page-inv">

  <!-- LOAD CARD (shown when no file loaded) -->
  <div class="card" id="load-card">
    <h2>Inventurdatei laden</h2>
    <p style="font-size:13px;color:var(--muted);margin-bottom:14px">
      "Inventory CHU.xxxx Kundenname.xlsx" aus der E-Mail laden.
    </p>
    <button class="btn btn-primary" onclick="document.getElementById('file-inp').click()">
      ğŸ“‚ XLSX aus E-Mail Ã¶ffnen
    </button>
    <input type="file" id="file-inp" accept=".xlsx,.xls" class="hidden" onchange="onFileLoad(this)">
    <p id="load-msg" style="font-size:13px;color:var(--muted);margin-top:10px"></p>
  </div>

  <!-- SCAN CARD (shown when file loaded) -->
  <div class="hidden" id="scan-card">
    <div class="stats">
      <div class="stat ok">   <div class="n" id="cnt-ok-stk">0</div>   <div class="lbl">GezÃ¤hlt</div>  </div>
      <div class="stat miss"> <div class="n" id="cnt-miss-stk">0</div> <div class="lbl">Fehlend</div>  </div>
      <div class="stat xtra"> <div class="n" id="cnt-xtra-stk">0</div> <div class="lbl">Extra</div>    </div>
    </div>
    <div class="card" style="padding:14px">
      <div class="pbar"><div class="pfill" id="pfill-stk" style="width:0%"></div></div>
      <div class="ptext" id="ptext-stk">â€”</div>
      <button class="btn btn-primary" id="btn-cam" style="margin-top:12px" onclick="toggleScan()">
        ğŸ“· Scannen starten
      </button>
    </div>

    <!-- Manual entry -->
    <div class="card">
      <h2 style="margin-bottom:10px">Manuelle Eingabe</h2>
      <div class="search-row">
        <input type="text" id="manual-inp" placeholder="Teilenummer â€¦" inputmode="numeric"
               onkeyup="if(event.key==='Enter')onManualAdd()">
        <button onclick="onManualAdd()">â•</button>
      </div>
    </div>

    <!-- NORMAL MODE: gezÃ¤hlte Artikel + Aktionen (kein Tab-Wechsel nÃ¶tig) -->
    <div id="normal-finish-section">
      <div id="normal-finish-body"></div>
      <button class="btn btn-success" style="margin-top:4px" onclick="downloadXLSX()">
        â¬‡ï¸ AusgefÃ¼llte XLSX herunterladen
      </button>
      <p style="font-size:12px;color:var(--muted);text-align:center;margin-top:8px">
        Anschliessend als Mail-Anhang an Materialbewirtschafter senden
      </p>
      <hr class="divider">
      <button class="btn btn-danger btn-sm" onclick="resetSession()">
        ğŸ—‘ Neue Inventur starten
      </button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• PAGE: TEILSUCHE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="page hidden" id="page-suche">
  <div class="card">
    <h2>ğŸ” Teilsuche</h2>
    <p style="font-size:13px;color:var(--muted);margin-bottom:12px">
      Wo liegt welche Menge? QOH = Bestand laut System Â· MIN = Soll
    </p>
    <div class="search-row">
      <input type="text" id="srch-inp" placeholder="Teilenummer â€¦" inputmode="numeric"
             onkeyup="if(event.key==='Enter')doSearch()">
      <button onclick="doSearch()">ğŸ”</button>
    </div>
    <button class="btn btn-outline btn-sm" style="margin-bottom:14px" onclick="startSearchScan()">
      ğŸ“· Barcode scannen
    </button>
    <div id="srch-result"></div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• PAGE: MERGE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="page hidden" id="page-merge">
  <div class="card">
    <h2>ğŸ¤ Kollegen-Scan zusammenfÃ¼hren</h2>
    <p style="font-size:13px;color:var(--muted);margin-bottom:16px">
      Kollege zeigt seinen QR-Code â†’ du scannst ihn â†’ Mengen werden addiert.
    </p>
    <button class="btn btn-primary" onclick="startQRImport()">
      ğŸ“· QR-Code des Kollegen scannen
    </button>

    <hr class="divider">

    <h2 style="margin-bottom:8px">Meinen Scan teilen</h2>
    <p style="font-size:13px;color:var(--muted);margin-bottom:12px">
      Kollege scannt diesen QR-Code mit der App.
    </p>
    <button class="btn btn-outline" onclick="showExportQR()">
      ğŸ”² QR-Code anzeigen
    </button>
    <div id="qr-container" class="hidden" style="display:flex;justify-content:center;margin:16px 0"></div>
    <p id="qr-msg" style="font-size:14px;text-align:center;margin-top:8px;font-weight:600"></p>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• PAGE: ABSCHLUSS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="page hidden" id="page-finish">
  <div class="card">
    <h2>âœ… Inventur abschliessen</h2>
    <div id="finish-body" style="margin-top:8px"></div>
    <button class="btn btn-success" style="margin-top:16px" onclick="downloadXLSX()">
      â¬‡ï¸ AusgefÃ¼llte XLSX herunterladen
    </button>
    <p style="font-size:12px;color:var(--muted);text-align:center;margin-top:8px">
      Anschliessend als Mail-Anhang an Materialbewirtschafter senden
    </p>
    <hr class="divider">
    <button class="btn btn-danger btn-sm" onclick="resetSession()">
      ğŸ—‘ Neue Inventur starten
    </button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     BOTTOM NAV
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<nav>
  <button class="active" id="nav-inv"    onclick="showPage('inv',    this)"><span class="ico">ğŸ“¦</span>Inventur</button>
  <button               id="nav-suche"  onclick="showPage('suche',  this)"><span class="ico">ğŸ”</span>Suche</button>
  <button               id="nav-merge"  onclick="showPage('merge',  this)"><span class="ico">ğŸ¤</span>Merge</button>
  <button               id="nav-finish" onclick="showPage('finish', this)"><span class="ico">âœ…</span>Abschluss</button>
</nav>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     QUANTITY MODAL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="modal-bg" id="qty-modal">
  <div class="modal">
    <div class="modal-title" id="m-nr">â€”</div>
    <div class="modal-sub"   id="m-name">â€”</div>

    <div class="info-grid" id="qty-info-grid">
      <div class="info-cell">
        <div class="lbl">Bisher gezÃ¤hlt</div>
        <div class="val val-neutral" id="m-cur">0</div>
      </div>
      <div class="info-cell info-expert">
        <div class="lbl">MIN laut System</div>
        <div class="val val-neutral" id="m-min">â€”</div>
      </div>
      <div class="info-cell info-expert">
        <div class="lbl">QOH laut System</div>
        <div class="val val-neutral" id="m-qoh">â€”</div>
      </div>
    </div>

    <p style="text-align:center;font-size:14px;color:var(--muted);margin-bottom:8px">Jetzt hinzufÃ¼gen:</p>
    <div class="qty-row">
      <button class="qty-btn minus" onclick="adjQty(-1)">âˆ’</button>
      <div class="qty-input-wrap">
        <input type="number" id="qty-val" value="1" min="1" max="999" onchange="refreshTotal()">
      </div>
      <button class="qty-btn plus"  onclick="adjQty(+1)">+</button>
    </div>
    <div class="qty-total">Neu total: <strong id="m-total">1</strong></div>

    <button class="btn btn-success" onclick="confirmQty()">âœ“ HinzufÃ¼gen</button>
    <button class="btn btn-outline" style="margin-top:10px" onclick="closeQtyModal()">Abbrechen</button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     MAIN SCAN MODAL (inventory)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="modal-bg" id="scan-modal">
  <div class="modal">
    <div class="scanner-wrap">
      <video id="video-main" playsinline muted autoplay></video>
    </div>
    <p id="scan-hint" style="text-align:center;color:var(--muted);font-size:13px;padding:10px 0 4px">
      Barcode mittig in den Rahmen halten â€¦
    </p>
    <div style="display:flex;gap:8px;margin-top:4px">
      <button class="btn btn-sm btn-sound" id="btn-sound-main" onclick="toggleSound()" style="flex:1">ğŸ”” Ton</button>
      <button class="btn btn-outline btn-sm" style="flex:1" onclick="stopScan()">â¹ Stoppen</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     QR SCAN MODAL (import colleague)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="modal-bg" id="qr-modal">
  <div class="modal">
    <h2 style="margin-bottom:16px">QR-Code scannen</h2>
    <video id="video-qr" playsinline muted autoplay></video>
    <button class="btn btn-outline" style="margin-top:16px" onclick="closeQRModal()">Abbrechen</button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SEARCH SCAN MODAL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="modal-bg" id="ss-modal">
  <div class="modal">
    <div class="scanner-wrap">
      <video id="video-ss" playsinline muted autoplay></video>
    </div>
    <p style="text-align:center;color:var(--muted);font-size:13px;padding:10px 0 4px">
      Barcode mittig in den Rahmen halten â€¦
    </p>
    <div style="display:flex;gap:8px;margin-top:4px">
      <button class="btn btn-sm btn-sound" id="btn-sound-ss" onclick="toggleSound()" style="flex:1">ğŸ”” Ton</button>
      <button class="btn btn-outline btn-sm" style="flex:1" onclick="closeSSModal()">Abbrechen</button>
    </div>
  </div>
</div>


<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     JAVASCRIPT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script>
'use strict';

// â”€â”€ CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const MASTERLIST_URL  = 'data/masterlist.json';
const SESSION_KEY     = 'inventur_v1';

// â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const S = {
  ml:        null,   // masterlist JSON
  inv:       null,   // [{tag, item, bezeichnung, subinventory, rowIdx}]
  wh:        null,   // "CHU.8678"
  whName:    null,   // "Edubook"
  fname:     null,   // original filename
  fdata:     null,   // ArrayBuffer of original xlsx
  fdataB64:  null,   // base64 of fdata (for localStorage)
  scanned:   {},     // {itemNr: count}
};

// â”€â”€ READERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let reader1D = null;  // main scanner
let readerQR = null;  // QR import
let readerSS = null;  // search scan

// Pending item for qty modal
let pendingCode = null;

// Debounce
let lastCode = null, lastCodeTime = 0;

// Scanner auto-reopen after qty confirm
let scannerAutoReopen = false;

// Sound + Haptic
let soundOn  = localStorage.getItem('inventur_sound') !== '0'; // default: an
let audioCtx = null;

// Expert Mode
let expertMode = localStorage.getItem('inventur_expert') === '1';
let _buildTaps = 0, _buildTimer = null;
function onBuildTap() {
  _buildTaps++;
  clearTimeout(_buildTimer);
  _buildTimer = setTimeout(() => { _buildTaps = 0; }, 2000);
  if (_buildTaps >= 7) {
    _buildTaps = 0;
    clearTimeout(_buildTimer);
    if (expertMode) {
      expertMode = false;
      localStorage.removeItem('inventur_expert');
      _updateBuildLabel();
      applyMode();
      renderFinish();
    } else {
      const pin = prompt('PIN:');
      if (pin === '675756') {
        expertMode = true;
        localStorage.setItem('inventur_expert', '1');
        _updateBuildLabel();
        applyMode();
        renderFinish();
      }
    }
  }
}
function _updateBuildLabel() {
  const el = document.getElementById('build-lbl');
  if (!el) return;
  el.style.opacity = expertMode ? '1' : '.55';
  el.style.color   = expertMode ? '#f59e0b' : '';
}

function applyMode() {
  if (expertMode) {
    document.body.classList.add('expert-mode');
  } else {
    document.body.classList.remove('expert-mode');
    // Falls man auf einem Tab war, der im Normal Mode nicht existiert â†’ zurÃ¼ck zu Inventur
    const hiddenPages = ['page-suche', 'page-merge', 'page-finish'];
    if (hiddenPages.some(id => document.getElementById(id)?.classList.contains('active'))) {
      showPage('inv', document.getElementById('nav-inv'));
    }
    renderNormalFinish();
  }
}

// â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(async () => {
  // Load masterlist from GitHub Pages
  try {
    const r = await fetch(MASTERLIST_URL);
    if (r.ok) S.ml = await r.json();
  } catch (e) { console.warn('masterlist not loaded:', e); }

  // Restore session
  try {
    const raw = localStorage.getItem(SESSION_KEY);
    if (raw) {
      const s = JSON.parse(raw);
      Object.assign(S, {
        inv:      s.inv,
        wh:       s.wh,
        whName:   s.whName,
        fname:    s.fname,
        fdataB64: s.fdataB64,
        scanned:  s.scanned || {},
      });
      if (S.fdataB64) {
        S.fdata = b64ToBuffer(S.fdataB64);
      }
      if (S.inv) showScanCard();
    }
  } catch (e) { console.warn('session restore failed:', e); }

  updateUI();
  updateSoundButtons();
  _updateBuildLabel();
  applyMode();

  // â”€â”€ Web Share Target: eingehende XLSX-Datei verarbeiten â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if (location.search.includes('share-incoming=1')) {
    history.replaceState({}, '', location.pathname);
    try {
      const shareCache = await caches.open('inventur-share');
      const resp = await shareCache.match('incoming-file');
      if (resp) {
        const filename = resp.headers.get('X-Filename') || 'shared.xlsx';
        const buf = await resp.arrayBuffer();
        await shareCache.delete('incoming-file');
        await _loadXlsx(buf, filename, document.getElementById('load-msg'));
      }
    } catch (e) { console.warn('Share target error:', e); }
  }
})();

// â”€â”€ PAGE NAVIGATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showPage(name, btn) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
  const page = document.getElementById('page-' + name);
  page.classList.remove('hidden');
  page.classList.add('active');
  btn.classList.add('active');
  if (name === 'finish') renderFinish();
}

// â”€â”€ FILE LOAD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function onFileLoad(input) {
  const file = input.files[0];
  if (!file) return;
  const msg = document.getElementById('load-msg');
  msg.textContent = 'Lade â€¦';
  await _loadXlsx(await file.arrayBuffer(), file.name, msg);
  input.value = '';
}

async function _loadXlsx(buf, filename, msg) {
  try {
    const wb  = XLSX.read(buf, { type: 'array' });

    // Find inventory sheet
    const wsName = wb.SheetNames.find(n => n.toLowerCase().includes('fnd_gfm'))
                   || wb.SheetNames[0];
    const ws  = wb.Sheets[wsName];
    const raw = XLSX.utils.sheet_to_json(ws, { header: 1, defval: '' });

    const hdr  = raw[0].map(h => String(h).trim());
    const iTag = hdr.indexOf('Tag');
    const iItm = hdr.indexOf('Item');
    const iBez = hdr.indexOf('Bezeichnung');
    const iSub = hdr.indexOf('Subinventory');

    if (iItm < 0) throw new Error('Spalte "Item" nicht gefunden â€“ falsche Datei?');

    S.inv = [];
    for (let r = 1; r < raw.length; r++) {
      const itm = String(raw[r][iItm] || '').trim();
      if (!itm) continue;
      S.inv.push({
        tag:  String(raw[r][iTag] || '').trim(),
        item: itm,
        bez:  String(raw[r][iBez] || '').trim(),
        sub:  String(raw[r][iSub] || '').trim(),
        row:  r,
      });
    }

    // Extract warehouse from filename  "Inventory CHU.8678 Edubook.xlsx"
    const m = filename.match(/CHU\.\d+/i);
    S.wh     = m ? m[0].toUpperCase() : null;
    S.whName = filename
                 .replace(/^Inventory\s+/i, '')
                 .replace(/CHU\.\d+\s*/i, '')
                 .replace(/\.xlsx?$/i, '')
                 .trim();
    S.fname   = filename;
    S.fdata   = buf;
    S.fdataB64 = bufToB64(buf);
    S.scanned  = {};

    saveSession();
    showScanCard();
    updateUI();
    if (msg) msg.textContent = '';

  } catch (e) {
    if (msg) msg.textContent = 'Fehler: ' + e.message;
  }
}

function showScanCard() {
  document.getElementById('load-card').classList.add('hidden');
  document.getElementById('scan-card').classList.remove('hidden');
}

// â”€â”€ UI UPDATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateUI() {
  if (!S.inv) return;
  const total = S.inv.length;
  let ok = 0, totalQoh = 0, scannedQoh = 0, totalDeficit = 0;
  for (const i of S.inv) {
    const sc     = S.scanned[i.item] || 0;
    const qoh    = S.ml?.i?.[i.item]?.l?.[S.wh]?.qoh ?? null;
    const target = qoh !== null ? qoh : 1;
    const deficit = Math.max(0, target - sc);
    if (deficit === 0) ok++;
    else totalDeficit += deficit;
    if (qoh !== null) {
      totalQoh   += qoh;
      scannedQoh += Math.min(sc, qoh);
    }
  }
  const extraItems = Object.keys(S.scanned).filter(k => !S.inv.find(i => i.item === k));
  const extraStk   = extraItems.reduce((s, k) => s + (S.scanned[k] || 0), 0);

  document.getElementById('cnt-ok-stk').textContent   = Object.values(S.scanned).reduce((s,v)=>s+v,0);
  document.getElementById('cnt-miss-stk').textContent = totalDeficit;
  document.getElementById('cnt-xtra-stk').textContent = extraStk;

  document.getElementById('pfill-stk').style.width = totalQoh ? (scannedQoh / totalQoh * 100) + '%' : '0%';
  document.getElementById('ptext-stk').textContent = expertMode
    ? (totalQoh ? `${scannedQoh} von ${totalQoh} Stk. korrekt im Lager` : 'â€”')
    : '';

  const sub = document.getElementById('hdr-sub');
  sub.textContent = S.wh
    ? `${S.wh}  Â·  ${S.whName || ''}`
    : 'Keine Inventurdatei geladen';
  if (!expertMode) renderNormalFinish();
}

// â”€â”€ SOUND + HAPTIC â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateSoundButtons() {
  document.querySelectorAll('.btn-sound').forEach(btn => {
    btn.textContent = soundOn ? 'ğŸ”” Ton an' : 'ğŸ”• Ton aus';
    btn.classList.toggle('off', !soundOn);
  });
}

function toggleSound() {
  soundOn = !soundOn;
  localStorage.setItem('inventur_sound', soundOn ? '1' : '0');
  // AudioContext beim ersten Einschalten via User-Gesture anlegen (iOS-Pflicht)
  if (soundOn && !audioCtx) {
    try { audioCtx = new (window.AudioContext || window.webkitAudioContext)(); } catch (_) {}
  }
  updateSoundButtons();
}

function playBeep() {
  if (!soundOn) return;
  try {
    if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    if (audioCtx.state === 'suspended') audioCtx.resume();
    const osc  = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.connect(gain);
    gain.connect(audioCtx.destination);
    osc.frequency.value = 1320;
    osc.type = 'sine';
    gain.gain.setValueAtTime(0.4, audioCtx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.12);
    osc.start(audioCtx.currentTime);
    osc.stop(audioCtx.currentTime + 0.12);
  } catch (_) {}
}

// â”€â”€ MAIN SCANNER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function toggleScan() {
  const modal = document.getElementById('scan-modal');
  if (modal.classList.contains('open')) { stopScan(); return; }

  modal.classList.add('open');
  document.getElementById('btn-cam').textContent = 'â¹ Scannen stoppen';

  // AudioContext vorab anlegen (User-Gesture vorhanden)
  if (soundOn && !audioCtx) {
    try { audioCtx = new (window.AudioContext || window.webkitAudioContext)(); } catch (_) {}
  }

  if (!reader1D) reader1D = new ZXing.BrowserMultiFormatReader();
  try {
    await reader1D.decodeFromConstraints(
      { video: { facingMode: { ideal: 'environment' } } },
      'video-main',
      (result) => { if (result) handleCode(result.getText()); }
    );
  } catch (e) {
    alert('Kamera-Fehler: ' + e.message);
    stopScan();
  }
}

function stopScan() {
  if (reader1D) { try { reader1D.reset(); } catch (_) {} }
  document.getElementById('scan-modal').classList.remove('open');
  document.getElementById('btn-cam').textContent = 'ğŸ“· Scannen starten';
}

function handleCode(code) {
  // Nur 7- oder 10-stellige Zahlen akzeptieren
  if (!/^(\d{7}|\d{10})$/.test(code)) return;

  const now = Date.now();
  if (code === lastCode && now - lastCodeTime < 2500) return;
  if (document.getElementById('qty-modal').classList.contains('open')) return;
  lastCode = code; lastCodeTime = now;

  // Scanner schliessen, danach automatisch wieder Ã¶ffnen
  scannerAutoReopen = true;
  stopScan();

  const invItem = S.inv?.find(i => i.item === code);
  const name = invItem?.bez || S.ml?.i?.[code]?.n || '';
  document.getElementById('scan-hint').textContent = name ? `${code}  Â·  ${name}` : `Erkannt: ${code}`;
  playBeep();
  if (soundOn && navigator.vibrate) navigator.vibrate(60);
  openQtyModal(code);
}

// â”€â”€ MANUAL ADD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function onManualAdd() {
  const inp  = document.getElementById('manual-inp');
  const code = inp.value.trim();
  if (!code) return;
  inp.value = '';
  openQtyModal(code);
}

// â”€â”€ QUANTITY MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openQtyModal(code) {
  pendingCode = code;
  const invItem = S.inv?.find(i => i.item === code);
  const name    = invItem?.bez || S.ml?.i?.[code]?.n || '(nicht in Inventurliste)';
  const current = S.scanned[code] || 0;

  let minV = 'â€”', qohV = 'â€”';
  const mlEntry = S.ml?.i?.[code];
  if (mlEntry && S.wh && mlEntry.l[S.wh]) {
    minV = mlEntry.l[S.wh].min;
    qohV = mlEntry.l[S.wh].qoh;
  }

  document.getElementById('m-nr').textContent    = code;
  document.getElementById('m-name').textContent  = name;
  document.getElementById('m-cur').textContent   = current;
  document.getElementById('m-min').textContent   = minV;
  document.getElementById('m-qoh').textContent   = qohV;
  document.getElementById('qty-val').value       = 1;
  refreshTotal();
  document.getElementById('qty-info-grid').classList.toggle('expert', expertMode);

  document.getElementById('qty-modal').classList.add('open');
  document.getElementById('qty-val').focus();
}

function adjQty(delta) {
  const inp = document.getElementById('qty-val');
  inp.value = Math.max(1, (parseInt(inp.value) || 1) + delta);
  refreshTotal();
}

function refreshTotal() {
  const add     = Math.max(1, parseInt(document.getElementById('qty-val').value) || 1);
  const current = S.scanned[pendingCode] || 0;
  document.getElementById('m-total').textContent = current + add;
}

function confirmQty() {
  if (!pendingCode) return;
  const add = Math.max(1, parseInt(document.getElementById('qty-val').value) || 1);
  S.scanned[pendingCode] = (S.scanned[pendingCode] || 0) + add;
  saveSession();
  updateUI();
  const reopen = scannerAutoReopen;
  scannerAutoReopen = false;
  closeQtyModal();
  if (reopen) toggleScan();   // Scanner automatisch wieder Ã¶ffnen
}

function closeQtyModal() {
  scannerAutoReopen = false;  // bei Abbrechen: kein Auto-Reopen
  document.getElementById('qty-modal').classList.remove('open');
  pendingCode = null;
  lastCode    = null;
}

// â”€â”€ PART SEARCH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function doSearch() {
  const q   = document.getElementById('srch-inp').value.trim();
  const div = document.getElementById('srch-result');
  if (!q) return;

  if (!S.ml?.i) {
    div.innerHTML = '<p style="color:var(--red)">Masterlist nicht geladen.</p>';
    return;
  }

  const entry = S.ml.i[q];
  if (!entry) {
    div.innerHTML = `<p style="color:var(--muted)">Kein Eintrag fÃ¼r <strong>${q}</strong> gefunden.</p>`;
    return;
  }

  const wmap = S.ml._w || {};
  const rows = Object.entries(entry.l || {})
    .sort((a, b) => a[0].localeCompare(b[0]))
    .map(([sub, loc]) => {
      const full  = wmap[sub] || sub;
      const short = full.replace(/\d{4,5}\s+/, '').replace(/\s*CSP\S+.*$/, '').trim();
      return `<tr>
        <td><strong>${sub}</strong></td>
        <td>${short}</td>
        <td style="text-align:center;font-weight:700">${loc.qoh}</td>
        <td style="text-align:center">${loc.min}</td>
      </tr>`;
    }).join('');

  div.innerHTML = `
    <div style="margin-bottom:12px">
      <strong style="font-size:16px">${q}</strong><br>
      <span style="color:var(--muted);font-size:13px">${entry.n}</span>
    </div>
    <table class="rtable">
      <thead><tr>
        <th>INV_LOC</th><th>Name</th>
        <th style="text-align:center">QOH</th>
        <th style="text-align:center">MIN</th>
      </tr></thead>
      <tbody>${rows}</tbody>
    </table>`;
}

async function startSearchScan() {
  const modal = document.getElementById('ss-modal');
  modal.classList.add('open');

  // AudioContext vorab anlegen (User-Gesture vorhanden)
  if (soundOn && !audioCtx) {
    try { audioCtx = new (window.AudioContext || window.webkitAudioContext)(); } catch (_) {}
  }

  if (!readerSS) readerSS = new ZXing.BrowserMultiFormatReader();
  try {
    await readerSS.decodeFromConstraints(
      { video: { facingMode: { ideal: 'environment' } } },
      'video-ss',
      (result) => {
        if (!result) return;
        const code = result.getText();
        if (!/^(\d{7}|\d{10})$/.test(code)) return;
        readerSS.reset();
        modal.classList.remove('open');
        playBeep();
        if (soundOn && navigator.vibrate) navigator.vibrate(60);
        document.getElementById('srch-inp').value = code;
        doSearch();
      });
  } catch (e) {
    alert('Kamera-Fehler: ' + e.message);
    modal.classList.remove('open');
  }
}

function closeSSModal() {
  if (readerSS) { try { readerSS.reset(); } catch (_) {} }
  document.getElementById('ss-modal').classList.remove('open');
}

// â”€â”€ QR EXPORT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function showExportQR() {
  const container = document.getElementById('qr-container');
  const msg       = document.getElementById('qr-msg');
  container.innerHTML = '';
  container.classList.add('hidden');
  msg.style.color = 'var(--muted)';
  msg.textContent = 'Generiere â€¦';

  if (typeof QRCode === 'undefined') {
    msg.style.color = 'var(--red)';
    msg.textContent = 'QR-Bibliothek nicht geladen â€“ Internet prÃ¼fen und Seite neu laden.';
    return;
  }

  const json = JSON.stringify(S.scanned || {});
  let payload;

  try {
    const cs     = new CompressionStream('gzip');
    const writer = cs.writable.getWriter();
    writer.write(new TextEncoder().encode(json));
    writer.close();
    const compressed = await new Response(cs.readable).arrayBuffer();
    payload = 'GZ:' + bufToB64(compressed);
  } catch (_) {
    payload = 'RAW:' + btoa(unescape(encodeURIComponent(json)));
  }

  const size   = payload.length;
  const nItems = Object.keys(S.scanned || {}).length;

  if (size > 2953) {
    msg.style.color = 'var(--red)';
    msg.textContent = `Zu gross (${size} Zeichen, max. 2953) â€“ Datei teilen.`;
    return;
  }

  try {
    const qrSize = Math.min(280, window.innerWidth - 60);
    new QRCode(container, {
      text:         payload,
      width:        qrSize,
      height:       qrSize,
      correctLevel: QRCode.CorrectLevel.M,
    });
    container.classList.remove('hidden');
    msg.style.color = 'var(--muted)';
    msg.textContent = `${nItems} Artikel Â· ${size} Zeichen`;
  } catch (e) {
    msg.style.color = 'var(--red)';
    msg.textContent = 'Fehler: ' + e.message;
  }
}

// â”€â”€ QR IMPORT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function startQRImport() {
  const modal = document.getElementById('qr-modal');
  modal.classList.add('open');

  if (!readerQR) readerQR = new ZXing.BrowserMultiFormatReader();
  try {
    await readerQR.decodeFromConstraints(
      { video: { facingMode: { ideal: 'environment' } } },
      'video-qr',
      async (result) => {
        if (!result) return;
        readerQR.reset();
        modal.classList.remove('open');
        await mergeQRPayload(result.getText());
      });
  } catch (e) {
    alert('Kamera-Fehler: ' + e.message);
    modal.classList.remove('open');
  }
}

async function mergeQRPayload(text) {
  try {
    let jsonStr;
    if (text.startsWith('GZ:')) {
      const bytes = b64ToBuffer(text.slice(3));
      const ds    = new DecompressionStream('gzip');
      const w     = ds.writable.getWriter();
      w.write(new Uint8Array(bytes)); w.close();
      jsonStr = await new Response(ds.readable).text();
    } else if (text.startsWith('RAW:')) {
      jsonStr = decodeURIComponent(escape(atob(text.slice(4))));
    } else {
      jsonStr = text;
    }

    const imported = JSON.parse(jsonStr);
    let n = 0;
    for (const [item, qty] of Object.entries(imported)) {
      S.scanned[item] = (S.scanned[item] || 0) + qty;
      n++;
    }
    saveSession();
    updateUI();
    alert(`${n} Positionen vom Kollegen hinzugefÃ¼gt!`);
  } catch (e) {
    alert('QR-Fehler: ' + e.message);
  }
}

function closeQRModal() {
  if (readerQR) { try { readerQR.reset(); } catch (_) {} }
  document.getElementById('qr-modal').classList.remove('open');
}

// â”€â”€ FINISH TAB â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderFinish() {
  const div = document.getElementById('finish-body');
  if (!S.inv) {
    div.innerHTML = '<p style="color:var(--muted)">Keine Inventur geladen.</p>';
    return;
  }

  // Jedes Teil: Soll = QOH aus Masterlist (Fallback: 1), Deficit = max(0, Soll âˆ’ GezÃ¤hlt)
  const extra = Object.entries(S.scanned)
                  .filter(([k]) => !S.inv.find(i => i.item === k));

  const scannedStk = Object.values(S.scanned).reduce((s, v) => s + v, 0);
  let totalDeficit = 0;
  const missingItems = [];
  const overItems   = [];

  for (const i of S.inv) {
    const sc     = S.scanned[i.item] || 0;
    const qoh    = S.ml?.i?.[i.item]?.l?.[S.wh]?.qoh ?? null;
    const target = qoh !== null ? qoh : 1;
    const deficit = Math.max(0, target - sc);
    if (deficit > 0) {
      totalDeficit += deficit;
      missingItems.push({ ...i, sc, qoh, deficit });
    } else if (qoh !== null && sc > qoh) {
      overItems.push({ ...i, sc, qoh, excess: sc - qoh });
    }
  }

  const extraStk = extra.reduce((s, [, v]) => s + v, 0);

  const missRows = missingItems.map(i => {
    const defCell = expertMode
      ? (i.qoh !== null
          ? `<td style="text-align:center;font-weight:700;color:var(--red)">${i.deficit}</td>`
          : `<td style="text-align:center;color:var(--muted)">â€”</td>`)
      : '';
    const scText = i.sc > 0 ? ` <span style="color:var(--orange);font-size:11px">(${i.sc} gez.)</span>` : '';
    return `<tr><td>${i.item}${scText}</td><td style="font-size:12px">${i.bez}</td>${defCell}</tr>`;
  }).join('');

  const xtraRows = extra.map(([k, v]) => {
    const bez = S.ml?.i?.[k]?.n || '';
    return `<tr><td>${k}</td><td style="font-size:12px">${bez}</td><td style="text-align:center">${v}</td></tr>`;
  }).join('');

  const overRows = overItems.map(i =>
    `<tr><td>${i.item}</td><td style="font-size:12px">${i.bez}</td><td style="text-align:center">${i.qoh}</td><td style="text-align:center;font-weight:700;color:var(--blue)">${i.sc}</td><td style="text-align:center;font-weight:700;color:var(--orange)">${i.excess}</td></tr>`
  ).join('');

  // GezÃ¤hlte Artikel: alle gescannten Positionen (Inventur + Extra), editierbar
  const inpStyle = 'width:58px;text-align:center;border:1px solid var(--border);border-radius:6px;padding:2px 4px;font-size:14px';
  const scannedRows = [
    ...S.inv
      .filter(i => (S.scanned[i.item] || 0) > 0)
      .map(i => ({
        item: i.item,
        bez:  i.bez || S.ml?.i?.[i.item]?.n || '',
        qoh:  S.ml?.i?.[i.item]?.l?.[S.wh]?.qoh ?? null,
        sc:   S.scanned[i.item],
      })),
    ...extra.map(([k, v]) => ({
      item: k,
      bez:  S.ml?.i?.[k]?.n || '',
      qoh:  null,
      sc:   v,
    })),
  ].map(i => {
    const qohCell = expertMode
      ? (i.qoh !== null
          ? `<td style="text-align:center">${i.qoh}</td>`
          : `<td style="text-align:center;color:var(--muted)">â€”</td>`)
      : '';
    return `<tr>
      <td>${i.item}</td>
      <td style="font-size:12px">${i.bez}</td>
      ${qohCell}
      <td style="text-align:center"><input type="number" min="0" value="${i.sc}" style="${inpStyle}" onchange="updateScanned('${i.item}',this.value)"></td>
    </tr>`;
  }).join('');

  div.innerHTML = `
    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:16px;text-align:center">
      <div><div style="font-size:28px;font-weight:800;color:var(--green)">${scannedStk}</div><div style="font-size:11px;color:var(--muted)">GezÃ¤hlt</div></div>
      <div><div style="font-size:28px;font-weight:800;color:var(--red)">${totalDeficit}</div><div style="font-size:11px;color:var(--muted)">Fehlend</div></div>
      <div><div style="font-size:28px;font-weight:800;color:var(--orange)">${extraStk}</div><div style="font-size:11px;color:var(--muted)">Extra</div></div>
    </div>

    ${scannedRows ? `
    <details style="margin-top:8px">
      <summary style="font-weight:600;color:var(--green)">GezÃ¤hlte Artikel (${Object.keys(S.scanned).length} Pos.)</summary>
      <table class="rtable" style="margin-top:8px">
        <thead><tr><th>Item-Nr.</th><th>Bezeichnung</th>${expertMode ? '<th style="text-align:center">QOH</th>' : ''}<th style="text-align:center">GezÃ¤hlt</th></tr></thead>
        <tbody>${scannedRows}</tbody>
      </table>
    </details>` : ''}

    ${missingItems.length ? `
    <details style="margin-top:8px">
      <summary style="font-weight:600;color:var(--red)">Fehlende Artikel (${missingItems.length} Pos. Â· ${totalDeficit} Stk.)</summary>
      <table class="rtable" style="margin-top:8px">
        <thead><tr><th>Item-Nr.</th><th>Bezeichnung</th>${expertMode ? '<th style="text-align:center">noch fehlend</th>' : ''}</tr></thead>
        <tbody>${missRows}</tbody>
      </table>
    </details>` : ''}

    ${expertMode && overItems.length ? `
    <details style="margin-top:8px">
      <summary style="font-weight:600;color:var(--blue)">Ãœberbestand (${overItems.length} Pos.)</summary>
      <table class="rtable" style="margin-top:8px">
        <thead><tr><th>Item-Nr.</th><th>Bezeichnung</th><th style="text-align:center">QOH</th><th style="text-align:center">GezÃ¤hlt</th><th style="text-align:center">Ãœberschuss</th></tr></thead>
        <tbody>${overRows}</tbody>
      </table>
    </details>` : ''}

    ${extra.length ? `
    <details style="margin-top:8px">
      <summary style="font-weight:600;color:var(--orange)">Extra-Artikel (${extra.length} Pos. Â· ${extraStk} Stk.)</summary>
      <table class="rtable" style="margin-top:8px">
        <thead><tr><th>Item-Nr.</th><th>Bezeichnung</th><th>Anzahl</th></tr></thead>
        <tbody>${xtraRows}</tbody>
      </table>
    </details>` : ''}
  `;
}

function renderNormalFinish() {
  const div = document.getElementById('normal-finish-body');
  if (!div || !S.inv) { if (div) div.innerHTML = ''; return; }

  const extra = Object.entries(S.scanned)
    .filter(([k]) => !S.inv.find(i => i.item === k));

  const inpStyle = 'width:58px;text-align:center;border:1px solid var(--border);border-radius:6px;padding:2px 4px;font-size:14px';
  const rows = [
    ...S.inv
      .filter(i => (S.scanned[i.item] || 0) > 0)
      .map(i => ({
        item: i.item,
        bez:  i.bez || S.ml?.i?.[i.item]?.n || '',
        sc:   S.scanned[i.item],
      })),
    ...extra.map(([k, v]) => ({
      item: k,
      bez:  S.ml?.i?.[k]?.n || '',
      sc:   v,
    })),
  ].map(i => `<tr>
    <td>${i.item}</td>
    <td style="font-size:12px">${i.bez}</td>
    <td style="text-align:center"><input type="number" min="0" value="${i.sc}" style="${inpStyle}" onchange="updateScanned('${i.item}',this.value)"></td>
  </tr>`).join('');

  div.innerHTML = rows
    ? `<details open style="margin-bottom:14px">
        <summary style="font-weight:600;color:var(--green)">GezÃ¤hlte Artikel (${Object.keys(S.scanned).length} Pos.)</summary>
        <table class="rtable" style="margin-top:8px">
          <thead><tr><th>Item-Nr.</th><th>Bezeichnung</th><th style="text-align:center">GezÃ¤hlt</th></tr></thead>
          <tbody>${rows}</tbody>
        </table>
      </details>`
    : '<p style="color:var(--muted);font-size:13px;margin:8px 0">Noch keine Artikel gezÃ¤hlt.</p>';
}

function updateScanned(item, val) {
  const n = Math.max(0, parseInt(val) || 0);
  if (n === 0) delete S.scanned[item];
  else S.scanned[item] = n;
  saveSession();
  updateUI();
  if (expertMode) renderFinish();
}

// â”€â”€ DOWNLOAD XLSX â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function downloadXLSX() {
  if (!S.fdata) {
    if (!S.fdataB64) {
      alert('Originaldatei nicht verfÃ¼gbar. Bitte XLSX neu laden.');
      return;
    }
    S.fdata = b64ToBuffer(S.fdataB64);
  }

  try {
    const wb     = XLSX.read(S.fdata, { type: 'array' });
    const wsName = wb.SheetNames.find(n => n.toLowerCase().includes('fnd_gfm'))
                   || wb.SheetNames[0];
    const ws     = wb.Sheets[wsName];
    const raw    = XLSX.utils.sheet_to_json(ws, { header: 1, defval: '' });
    const hdr    = raw[0].map(h => String(h).trim());

    const iItm = hdr.indexOf('Item');
    const iGez = hdr.indexOf('GezÃ¤hlt');
    const iBez = hdr.indexOf('Bezeichnung');

    if (iGez < 0) { alert('"GezÃ¤hlt"-Spalte nicht gefunden.'); return; }

    // Fill known items
    for (let r = 1; r < raw.length; r++) {
      const itm   = String(raw[r][iItm] || '').trim();
      if (!itm) continue;
      const count = S.scanned[itm] || 0;
      ws[XLSX.utils.encode_cell({ r, c: iGez })] = { t: 'n', v: count };
      if (iBez >= 0) {
        const bez = S.ml?.i?.[itm]?.n || String(raw[r][iBez] || '');
        ws[XLSX.utils.encode_cell({ r, c: iBez })] = { t: 's', v: bez };
      }
    }

    // Append extra items at bottom
    const extra = Object.entries(S.scanned)
                    .filter(([k]) => !S.inv?.find(i => i.item === k));
    let lastR = raw.length;
    for (const [item, count] of extra) {
      const newRow = Array(hdr.length).fill('');
      newRow[iItm] = item;
      newRow[iGez] = count;
      if (iBez >= 0) newRow[iBez] = S.ml?.i?.[item]?.n || '';
      XLSX.utils.sheet_add_aoa(ws, [newRow], { origin: lastR });
      lastR++;
    }
    // Update range
    ws['!ref'] = XLSX.utils.encode_range(
      { r: 0, c: 0 },
      { r: lastR - 1, c: hdr.length - 1 }
    );

    const outName = (S.fname || 'Inventur').replace(/\.xlsx?$/i, '') + '_ausgefÃ¼llt.xlsx';
    XLSX.writeFile(wb, outName);
  } catch (e) {
    alert('Fehler: ' + e.message);
  }
}

// â”€â”€ RESET â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function resetSession() {
  if (!confirm('Aktuelle Inventur lÃ¶schen und neu starten?')) return;
  stopScan();
  S.inv = S.fdata = S.fdataB64 = S.fname = S.wh = S.whName = null;
  S.scanned = {};
  localStorage.removeItem(SESSION_KEY);
  document.getElementById('load-card').classList.remove('hidden');
  document.getElementById('scan-card').classList.add('hidden');
  document.getElementById('hdr-sub').textContent = 'Keine Inventurdatei geladen';
  showPage('inv', document.getElementById('nav-inv'));
}

// â”€â”€ SESSION PERSIST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function saveSession() {
  try {
    localStorage.setItem(SESSION_KEY, JSON.stringify({
      inv:      S.inv,
      wh:       S.wh,
      whName:   S.whName,
      fname:    S.fname,
      fdataB64: S.fdataB64,
      scanned:  S.scanned,
    }));
  } catch (_) {}
}

// â”€â”€ UTILS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function bufToB64(buf) {
  const bytes = new Uint8Array(buf);
  let b = '';
  for (let i = 0; i < bytes.length; i++) b += String.fromCharCode(bytes[i]);
  return btoa(b);
}

function b64ToBuffer(b64) {
  const bin  = atob(b64);
  const buf  = new ArrayBuffer(bin.length);
  const view = new Uint8Array(buf);
  for (let i = 0; i < bin.length; i++) view[i] = bin.charCodeAt(i);
  return buf;
}

// â”€â”€ SERVICE WORKER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Neuer SW aktiviert sich automatisch (skipWaiting im Install-Handler).
// controllerchange â†’ Seite neu laden, Session bleibt via localStorage erhalten.
let swRefreshing = false;

if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('./sw.js')
    .catch(e => console.warn('SW Registrierung fehlgeschlagen:', e));

  navigator.serviceWorker.addEventListener('controllerchange', () => {
    if (!swRefreshing) { swRefreshing = true; location.reload(); }
  });
}
</script>

</body>
</html>
